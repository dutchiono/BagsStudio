server {
    server_name bagsstudio.xyz www.bagsstudio.xyz;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # Builder Service API
    location /api {
        proxy_pass http://localhost:3042;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;

        # Increase timeout for AI generation
        proxy_read_timeout 300s;
        proxy_connect_timeout 300s;
    }

    # Scanner API endpoints - must come before root location
    location ~ ^/scanner {
        proxy_pass http://localhost:3041;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # Scanner WebSocket updates
    location /scanner/updates {
        proxy_pass http://localhost:3041/scanner/updates;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket timeouts
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # Trading endpoints - must come before root location
    location ~ ^/trading {
        proxy_pass http://localhost:3041;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # SSE / Streaming endpoints
    location /api/project/stream {
        proxy_pass http://localhost:3042;
        proxy_http_version 1.1;
        proxy_set_header Connection '';
        proxy_set_header Host $host;
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding off;
        proxy_read_timeout 24h;
    }

    # Vite Preview Proxy - Dynamic port routing for project previews
    # Structure: /{username}/{projectSlug}/
    # Proxies to backend which looks up project and routes to Vite dev server
    # Note: This must come BEFORE the /p/ location for published projects
    # Username format: 3-20 chars (auto-generated: first8-last4 from wallet, e.g., "g1ae5jsd-pwdd")
    location ~ '^/([a-z0-9-]{3,20})/([^/]+)(/.*)?$' {
        proxy_pass http://localhost:3042/$1/$2$3$is_args$args;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # WebSocket support for Vite HMR
        proxy_set_header Connection "upgrade";

        # Increase timeouts for Vite
        proxy_read_timeout 300s;
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
    }

    # Published user projects
    # Structure: /p/{walletAddress}/{projectId}/
    # This serves files from /var/www/bags-studio/published/{wallet}/{project}/
    location ~ '^/p/([^/]+)/([^/]+)(/.*)?$' {
        alias /var/www/bags-studio/published/$1/$2$3;
        try_files $uri $uri/ /p/$1/$2/index.html;

        # Cache static assets
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
